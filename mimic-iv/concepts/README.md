# MIMIC-IV Concepts

Highlights

* This folder contains SQL scripts to generate useful abstractions of raw MIMIC-IV data ("concepts").
* The BigQuery dataset [mimiciv_derived](https://console.cloud.google.com/bigquery?ws=!1m4!1m3!3m2!1sphysionet-data!2smimiciv_derived) contains the data generated by this code
* A Python package is used to translate BigQuery dialect code into other SQL dialects

## Organization

Concepts are categorized into folders if possible, otherwise they remain in the top-level directory. All concepts are originally written in the **BigQuery Standard SQL Dialect**. A Python package is used to convert these BigQuery scripts into other dialects such as PostgreSQL.

Currently supported dialects include:

* [bigquery](/mimic-iv/concepts/bigquery)
* [postgres](/mimic-iv/concepts/postgres)
* [duckdb](/mimic-iv/concepts/duckdb)

[See below for how scripts in non-bigquery dialects were generated](#transpile).

The concepts are organized into individual SQL scripts, with each script generating a table. Access to this dataset is available to MIMIC-IV approved users: see the [cloud instructions](https://mimic.mit.edu/docs/gettingstarted/cloud/) on how to access MIMIC-IV on BigQuery (which includes the derived concepts).

* [List of the concept folders and their content](#concept-index)
* [Generating the concept tables on BigQuery](#generating-the-concepts-on-bigquery)
* [Generating the concept tables on PostgreSQL](#generating-the-concepts-on-postgresql)

## Concept Index

## Generating the concepts on BigQuery

**If you just want to use the data here, you can access each table as `physionet-data.mimiciv_derived.*`.**

Generating the concepts requires the [Google Cloud SDK](https://cloud.google.com/sdk) to be installed.
A shell script, [make_concepts.sh](/mimic-iv/concepts/make_concepts.sh), is provided which iterates over each folder and creates a table with the same name as the concept file. Concept names have been chosen to avoid collisions.

Generating a single concept can be done by calling the Google Cloud SDK as follows:

```sh
bq query --use_legacy_sql=False --replace --destination_table=my_bigquery_dataset.age < demographics/age.sql
```

In general the concepts may be generated in any order, except for the *first_day_sofa* and *kdigo_stages* tables, which depend on other tables.

## Generating the concepts on PostgreSQL

You should have already created a database with the MIMIC-IV data loaded in using the build scripts.
The [postgres](/mimic-iv/concepts/postgres) folder contains concepts in a PostgreSQL compatible dialect.
These concepts assume the output schema is `mimiciv_derived`. If you would like a different schema, you will need to make a few edits to the scripts.

## Transpile

The Python package [sqlglot]() is used to convert from one SQL dialect to another ("transpile").
This package parses the SQL into the abstract syntax tree (AST), after which is can be re-written into a specific dialect.
Not all functions are supported by sqlglot, so a helper package was written which adds support for the missing functions.
Most code is provided in the [transpile.py](/src/mimic_utils/transpile.py) file.

An entrypoint is provided for convenience. To transpile a single file, run:

```sh
mimic_utils convert_file mimic-iv/concepts/demographics/age.sql age.sql --destination_dialect duckdb
```

To transpile all files in a folder, run:

```sh
mimic_utils convert_folder mimic-iv/concepts mimic-iv/concepts_duckdb --destination_dialect duckdb
```
